name: sync
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch:
          - master
          - release-branch.go1.21

    steps:
      - name: checkout std
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: upstream/${{ matrix.branch }}

      - uses: actions/setup-go@v4
        with:
          go-version-file: ./_tools/go.mod
          cache-dependency-path: ./_tools/go.sum
      - name: install tools
        working-directory: ./_tools
        run: |
          go install ./importgodoc

      - name: checkout golang/go
        uses: actions/checkout@v4
        with:
          repository: golang/go
          ref: ${{ matrix.branch }}
          path: "../go"

      - name: sync
        env:
          BRANCH_NAME: ${{ matrix.branch }}
        run: |
          git switch "$BRANCH_NAME"
          ./_tools/rm-all.sh
          importgodoc "$GITHUB_WORKSPACE/../go" .
          git add .
          git diff --cached
